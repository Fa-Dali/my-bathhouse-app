–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ –∏–∑ –±–ª—ç–∫–ª–∏—Å—Ç–∞.

–û—Ç–ª–∏—á–Ω–æ, —á—Ç–æ —É—Ç–æ—á–Ω–∏–ª ‚Äî —É —Ç–µ–±—è Windows, –∏ —ç—Ç–æ –≤–∞–∂–Ω–æ, –ø–æ—Ç–æ–º—É —á—Ç–æ:

cron ‚Äî —Ç–æ–ª—å–∫–æ –≤ Linux
–ù–æ celery –∏ redis ‚Äî —Ä–∞–±–æ—Ç–∞—é—Ç –∏ –Ω–∞ Windows!
‚úÖ –î–∞, –º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –æ—á–∏—Å—Ç–∫—É –Ω–∞ Windows
üöÄ –†–µ—à–µ–Ω–∏–µ: Celery + Redis + Celery Beat
‚Üí –†–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ Windows
‚Üí –ù–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç cron
‚Üí –ü–æ–ª–Ω–æ—Å—Ç—å—é –≤ Django-—ç–∫–æ—Å–∏—Å—Ç–µ–º–µ

üß∞ –ß—Ç–æ –Ω—É–∂–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
bash
pip install celery redis django-celery-beat
django-celery-beat ‚Äî –ø–æ–∑–≤–æ–ª—è–µ—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ–º –∏–∑ –∞–¥–º–∏–Ω–∫–∏ Django, –∞ –Ω–µ –∏–∑ –∫–æ–¥–∞

üîß –®–∞–≥ 1: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ celery.py
–°–æ–∑–¥–∞–π –≤ my_bathhouse_backend/celery.py:

python
# my_bathhouse_backend/celery.py

import os
from celery import Celery
from django.conf import settings

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'my_bathhouse_backend.settings')

app = Celery('my_bathhouse_backend')

# –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ Django
app.config_from_object('django.conf:settings', namespace='CELERY')

# –ê–≤—Ç–æ–æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –∑–∞–¥–∞—á –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ö
app.autodiscover_tasks()
üîß –®–∞–≥ 2: –ü–æ–¥–∫–ª—é—á–∏ –≤ __init__.py
python
# my_bathhouse_backend/__init__.py

from .celery import app as celery_app

__all__ = ('celery_app',)
üîß –®–∞–≥ 3: –î–æ–±–∞–≤—å –∑–∞–¥–∞—á—É –¥–ª—è –æ—á–∏—Å—Ç–∫–∏
–°–æ–∑–¥–∞–π —Ñ–∞–π–ª tasks.py –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞ (my_bathhouse_backend/tasks.py):

python
# my_bathhouse_backend/tasks.py

from celery import shared_task
from django.core.management import call_command
import logging

logger = logging.getLogger(__name__)

@shared_task
def cleanup_expired_tokens():
    """–£–¥–∞–ª—è–µ—Ç –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ JWT-—Ç–æ–∫–µ–Ω—ã –∏–∑ —á—ë—Ä–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞"""
    try:
        logger.info("–ó–∞–ø—É—Å–∫ –æ—á–∏—Å—Ç–∫–∏ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤...")
        call_command('flushexpiredtokens')
        logger.info("‚úÖ –û—á–∏—Å—Ç–∫–∞ —Ç–æ–∫–µ–Ω–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–∞")
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ —Ç–æ–∫–µ–Ω–æ–≤: {e}")
üîß –®–∞–≥ 4: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ settings.py
–î–æ–±–∞–≤—å django_celery_beat –≤ INSTALLED_APPS:

python
# settings.py

INSTALLED_APPS = [
    # ...
    'django_celery_beat',
]

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Celery
CELERY_BROKER_URL = 'redis://127.0.0.1:6379/0'
CELERY_RESULT_BACKEND = 'redis://127.0.0.1:6379/0'
CELERY_ACCEPT_CONTENT = ['json']
CELERY_TASK_SERIALIZER = 'json'
CELERY_RESULT_SERIALIZER = 'json'
CELERY_TIMEZONE = 'Europe/Moscow'  # –£–∫–∞–∂–∏ —Å–≤–æ—é
üîß –®–∞–≥ 5: –£—Å—Ç–∞–Ω–æ–≤–∏ –∏ –∑–∞–ø—É—Å—Ç–∏ Redis –Ω–∞ Windows
‚è¨ –°–∫–∞—á–∞–π Redis –¥–ª—è Windows:
üîó –û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –ø–æ—Ä—Ç:
https://github.com/tporadowski/redis/releases

‚Üí –°–∫–∞—á–∞–π Redis-x64-xxx.zip
‚Üí –†–∞—Å–ø–∞–∫—É–π
‚Üí –ó–∞–ø—É—Å—Ç–∏ redis-server.exe

‚úÖ –û—Ç–∫—Ä–æ–π –¥—Ä—É–≥–æ–µ –æ–∫–Ω–æ ‚Üí –∑–∞–ø—É—Å—Ç–∏ redis-cli.exe ‚Üí –≤–≤–µ–¥–∏ PING ‚Üí –¥–æ–ª–∂–µ–Ω –æ—Ç–≤–µ—Ç–∏—Ç—å PONG

üîß –®–∞–≥ 6: –ó–∞–ø—É—Å–∫
–¢–µ—Ä–º–∏–Ω–∞–ª 1: –ó–∞–ø—É—Å—Ç–∏ Django
bash
python manage.py runserver
–¢–µ—Ä–º–∏–Ω–∞–ª 2: –ó–∞–ø—É—Å—Ç–∏ Celery Worker
bash
celery -A my_bathhouse_backend worker -l info
–¢–µ—Ä–º–∏–Ω–∞–ª 3: –ó–∞–ø—É—Å—Ç–∏ Celery Beat (–±—É–¥–µ—Ç –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é –≤—ã–∑—ã–≤–∞—Ç—å –∑–∞–¥–∞—á—É)
bash
celery -A my_bathhouse_backend beat -l info --scheduler django_celery_beat.schedulers:DatabaseScheduler
‚ö†Ô∏è –í–∞–∂–Ω–æ: --scheduler ‚Äî —á—Ç–æ–±—ã –±—Ä–∞–ª —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∏–∑ –ë–î

üîß –®–∞–≥ 7: –î–æ–±–∞–≤—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –≤ –∞–¥–º–∏–Ω–∫—É Django
–ó–∞–π–¥–∏ –≤ /admin
–ü–µ—Ä–µ–π–¥–∏ –≤ Periodic Tasks ‚Üí Add
–ó–∞–ø–æ–ª–Ω–∏:
| –ü–æ–ª–µ | –ó–Ω–∞—á–µ–Ω–∏–µ | |------|---------| | Name | –û—á–∏—Å—Ç–∫–∞ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤ | | Task | my_bathhouse_backend.tasks.cleanup_expired_tokens | | Interval | 1 day (–∏–ª–∏ —Å–æ–∑–¥–∞–π –∏–Ω—Ç–µ—Ä–≤–∞–ª Every 24 hours) |

–°–æ—Ö—Ä–∞–Ω–∏
‚úÖ –ß—Ç–æ –±—É–¥–µ—Ç?
–ö–∞–∂–¥—ã–µ 24 —á–∞—Å–∞:

celery beat ‚Üí –≥–æ–≤–æ—Ä–∏—Ç celery worker: "–í—ã–ø–æ–ª–Ω–∏ –∑–∞–¥–∞—á—É"
worker ‚Üí –∑–∞–ø—É—Å–∫–∞–µ—Ç cleanup_expired_tokens
‚Üí –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è python manage.py flushexpiredtokens
‚Üí —Å—Ç–∞—Ä—ã–µ —Ç–æ–∫–µ–Ω—ã —É–¥–∞–ª—è—é—Ç—Å—è –∏–∑ –ë–î
üß™ –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å?
–í tasks.py –¥–æ–±–∞–≤—å print("–û—á–∏—Å—Ç–∫–∞!")
–ó–∞–ø—É—Å—Ç–∏ beat –∏ worker
–£–≤–∏–¥–∏—à—å: –û—á–∏—Å—Ç–∫–∞! ‚Äî –∑–Ω–∞—á–∏—Ç, —Ä–∞–±–æ—Ç–∞–µ—Ç
‚úÖ –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ (–ø—Ä–æ—â–µ, –Ω–æ –≤—Ä—É—á–Ω—É—é)
–ï—Å–ª–∏ –ø–æ–∫–∞ —Å–ª–æ–∂–Ω–æ ‚Äî –ø—Ä–æ—Å—Ç–æ —Ä–∞–∑ –≤ –Ω–µ–¥–µ–ª—é –∑–∞–ø—É—Å–∫–∞–π –≤—Ä—É—á–Ω—É—é:

bash
python manage.py flushexpiredtokens
‚Üí –ò –≤—Å—ë –±—É–¥–µ—Ç —á–∏—Å—Ç–æ.

‚úÖ –í—ã–≤–æ–¥
–î–∞, –Ω–∞ Windows –º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –æ—á–∏—Å—Ç–∫—É:

–£—Å—Ç–∞–Ω–æ–≤–∏ Redis
–ù–∞—Å—Ç—Ä–æ–π Celery + django-celery-beat
–î–æ–±–∞–≤—å –∑–∞–¥–∞—á—É –≤ –∞–¥–º–∏–Ω–∫—É
–ó–∞–ø—É—Å—Ç–∏ worker –∏ beat
‚Üí –ò —Å–∏—Å—Ç–µ–º–∞ –±—É–¥–µ—Ç —Å–∞–º–∞ —á–∏—Å—Ç–∏—Ç—å –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã

üëâ –ù–∞–ø–∏—à–∏:

¬´–ó–∞–ø—É—Å—Ç–∏–ª ‚Äî –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç¬ª

–ò–ª–∏:

¬´–ö–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å –∏–Ω—Ç–µ—Ä–≤–∞–ª –≤ –∞–¥–º–∏–Ω–∫–µ?¬ª

–Ø ‚Äî –ø–æ–º–æ–≥—É.
–¢—ã —É–∂–µ —Å—Ç—Ä–æ–∏—à—å —Å–∞–º–æ–æ—á–∏—â–∞—é—â—É—é—Å—è —Å–∏—Å—Ç–µ–º—É.
–≠—Ç–æ –∫—Ä—É—Ç–æ. ‚úÖ
-------------------------------
üïí –ö–∞–∫ —á–∞—Å—Ç–æ –≤—ã–ø–æ–ª–Ω—è—Ç—å?
| –°—Ä–µ–¥–∞ | –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è | |------|-------------| | –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ | –†–∞–∑ –≤ 1‚Äì2 –Ω–µ–¥–µ–ª–∏ | | –ü—Ä–æ–¥–∞–∫—à–Ω (–±–æ–µ–≤–æ–π —Å–µ—Ä–≤–µ—Ä) | –†–∞–∑ –≤ –¥–µ–Ω—å ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (—Å–º. –Ω–∏–∂–µ) |

üîß –ö–∞–∫ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –æ—á–∏—Å—Ç–∫—É? (–Ω–∞ –±—É–¥—É—â–µ–µ)
–í–∞—Ä–∏–∞–Ω—Ç 1: Celery + Redis (–Ω–∞ Windows ‚Äî —Ä–∞–±–æ—Ç–∞–µ—Ç)
–£—Å—Ç–∞–Ω–æ–≤–∏ Redis –¥–ª—è Windows (https://github.com/tporadowski/redis)
–ó–∞–ø—É—Å—Ç–∏ redis-server.exe
–ó–∞–ø—É—Å—Ç–∏ Celery Beat (–∫–∞–∫ —è –ø–æ–∫–∞–∑—ã–≤–∞–ª —Ä–∞–Ω–µ–µ)
–û–Ω –±—É–¥–µ—Ç —Å–∞–º —Ä–∞–∑ –≤ –¥–µ–Ω—å –≤—ã–ø–æ–ª–Ω—è—Ç—å flushexpiredtokens
–í–∞—Ä–∏–∞–Ω—Ç 2: –í—Ä—É—á–Ω—É—é –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é
–°–æ–∑–¥–∞–π .bat —Ñ–∞–π–ª –Ω–∞ Windows:

bat
@echo off
cd /d D:\Projects\my-bathhouse-app\backend
call env\Scripts\activate
python manage.py flushexpiredtokens
–°–æ—Ö—Ä–∞–Ω–∏ –∫–∞–∫ cleanup_tokens.bat

‚Üí –ó–∞—Ç–µ–º –Ω–∞—Å—Ç—Ä–æ–π –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞–Ω–∏–π Windows, —á—Ç–æ–±—ã –æ–Ω –∑–∞–ø—É—Å–∫–∞–ª —ç—Ç–æ—Ç .bat –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 3:00.

‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å—Ç—å –ª–∏ —á—Ç–æ —É–¥–∞–ª—è—Ç—å?
–ú–æ–∂–µ—à—å –≥–ª—è–Ω—É—Ç—å –≤ –ë–î:

sql
-- –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å SQLite (—á–µ—Ä–µ–∑ DB Browser –∏–ª–∏ Django shell)
SELECT * FROM token_blacklist_outstandingtoken WHERE expires_at < datetime('now');
‚Üí –ü–æ–∫–∞–∂–µ—Ç –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã

üìå –ò—Ç–æ–≥
| –ß—Ç–æ –¥–µ–ª–∞—Ç—å | –ö–æ–º–∞–Ω–¥–∞ | |----------|--------| | –û—á–∏—Å—Ç–∏—Ç—å –≤—Ä—É—á–Ω—É—é | python manage.py flushexpiredtokens | | –ì–¥–µ –∑–∞–ø—É—Å–∫–∞—Ç—å | –í –ø–∞–ø–∫–µ backend, –≤ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–Ω–æ–º env | | –ß–∞—Å—Ç–æ—Ç–∞ | –†–∞–∑ –≤ –Ω–µ–¥–µ–ª—é (–ø–æ–∫–∞ –≤—Ä—É—á–Ω—É—é), –ø–æ—Ç–æ–º ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ |